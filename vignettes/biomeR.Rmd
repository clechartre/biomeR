# biomeR

biomeR is an R frontend that calls the Julia package [Biome.jl](https://github.com/clechartre/Biome.jl) through JuliaCall. The typical workflow is:

1.  Clone [Biome.jl](https://github.com/clechartre/Biome.jl) (until it is registered)
2.  Initialize Julia + Biome.jl (biome_setup())
3.  Load input rasters in R
4.  Build PFTs (pft()) or edit a BIOME4 PFT list
5.  Run the model (run_biome()), producing a NetCDF output

## Installation

### Requirements

-   R (\>= 4.1 recommended)
-   Julia (\>= 1.10 recommended)
-   A working installation of Biome.jl as long as it is not registered (clone it)

### Installation

Install biomeR

```{r}
install.packages("remotes")
remotes::install_github("https://github.com/clechartre/biomeR")
```

Install Julia and JuliaCall

```{r}
install.packages("JuliaCall")
```

If Julia is not installed, get it through JuliaCall

```{r}
library(JuliaCall)
julia_setup(installJulia = TRUE)
```

Point biomeR to your Biome.jl checkout (dev mode) Biome.jl is not registered yet, so you must have a local checkout of Biome.jl and pass its project directory to biome_setup()

```{r}
library(biomeR)

biome <- biome_setup(
project_dir = "/path/to/Biome.jl", # Your Biome.jl clone
pkg_check = TRUE
)
```

# Inputs

Biome expects climate inputs as rasters (usually monthly/12 bands).

This vignette uses the raster package objects (RasterLayer, RasterBrick, RasterStack). If you use `terra`, convert to raster first or add a terra adapter later.

We use [CHELSA](https://www.chelsa-climate.org/datasets) climatologies as inputs, but feel free to use anything else, as long as all inputs are on the same format.

We recommend generating your soil data using [makesoil](https://github.com/ARVE-Research/makesoil)

```{r}
library(raster)

temp <- brick("/path/to/temp.nc", varname = "temp")
prec <- brick("/path/to/prec.nc", varname = "prec")
clt  <- brick("/path/to/sun.nc",  varname = "sun") 

whc  <- brick("/path/to/soils.nc", varname = "whc")
ksat <- brick("/path/to/soils.nc", varname = "Ksat")

nlayers(temp)  # should be 12

# Then pass your rasters as a named list
rasters <- list(
                temp = temp,
                prec = prec,
                clt  = clt,
                whc  = whc,
                ksat = ksat
            )
```

# Running the model

## Example 1. BIOME4 and its built-in PFTs

Biome allows you to run the BIOME4 model in its original form, or with modified parametrizations. You can edit the PFT list with with `set_pft_characteristic()`.

Create a BIOME4 list and edit it

```{r}
biome <- biome_setup(project_dir = "/path/to/Biome.jl")

# Load the BIOME4 PFTs
PFTList <- biome$api$make_biome4_pftclassification()

# Modify the GDD5 constraint of your PFTs, this is totally optional
# You can find a list of PFT characteristics in the package documentation
biome$api$set_pft_characteristic(PFTList, "BorealEvergreen", "gdd5", c(750.0, 1200.0), need_return = "None")
biome$api$set_pft_characteristic(PFTList, "BorealDeciduous", "gdd5", c(1250.0, 1750.0),need_return = "None")
```

Run the model

```{r}
outfile <- file.path(tempdir(), "biome_output_biome4.nc")

run_biome(
            rasters = rasters,
            model = "BIOME4Model",
            co2 = 373.8,
            pftlist = PFTList,
            outfile = outfile,
            coordstring = "alldata",
            biome = biome # Prevents from re-instantiating the Julia install, optional
        )
```

## Example 2. Make your own PFTs, run the Base model

You can build a PFT in R using `pft()`

```{r}
library(biomeR)

succulent <- pft(
                type = "BroadleafDeciduousPFT",
                name = "Succulent",
                phenological_type = 2,
                max_min_canopy_conductance = 0.05,
                Emax = 8.0,
                constraints = list(
                tcm   = c(10, Inf),
                tmin  = c(-5, Inf),
                gdd0  = c(-Inf, 10000),
                swb   = c(50, 600),
                tprec = c(-Inf, 1200)
                ),
                mean_val = list(clt = 72.7, prec = 20.0, temp = 21.7),
                sd_val   = list(clt = 20.3, prec = 80.4, temp = 8.9),
                dominance_factor = 9,
                minimum_lai = 2.0
            )

randompft <- pft(
                type = "BroadleafEvergreenPFT",
                name = "RandomPFT",
                phenological_type = 2,
                max_min_canopy_conductance = 0.5,
                Emax = 12.0
            )

pft_specs <- list(succulent, randompft)
```

Run the model with these toy examples. This will probably look bad.

```{r}
outfile <- file.path(tempdir(), "biome_output_base.nc")

run_biome(
            rasters = rasters,
            model = "BaseModel",
            co2 = 373.8,
            pft_specs = pft_specs,
            outfile = outfile,
            coordstring = "alldata",
            project_dir = "/path/to/Biome.jl"   # needed in dev mode
        )

outfile
```
